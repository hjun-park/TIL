# Thread Local

## 1. `Thread Local`ì´ë€ ?

- Thread ë³„ë¡œ ê³ ìœ í•œ ê°’ì„ ê°€ì§€ëŠ” ë³€ìˆ˜
- `Thread` ì§€ì—­ë³€ìˆ˜ë¼ê³  ë³´ë©´ ëœë‹¤, ê°ê°ì˜ `Thread`ê°€ í•˜ë‚˜ì˜ `ThreadLocal`ì„ ê³µìœ í•´ë„ ë‹¤ë¥¸ ê°’ì„ ë°”ë¼ë³¸ë‹¤.
- `ThreadLocalMap`ì„ ì‚¬ìš©í•˜ì—¬ `Thread` ì •ë³´ë¥¼ `key`ë¡œ í•˜ê³  `value`ë¡œ `ThreadLocal` ê°ì²´(ë°ì´í„°)ë¥¼ ì €ì¥í•œë‹¤.

### 1-1. ğŸ”µ `ThreadLocal`ì„ ì™œ ì‚¬ìš©í• ê¹Œ ?

#### ğŸ”µ ê¸°ë³¸ì ìœ¼ë¡œ `thread`ì˜ `stack`ì€ ì„œë¡œ ê³µìœ ê°€ ë˜ì§€ ì•ŠëŠ”ë‹¤.

- ê°ì²´ëŠ” ë³´í†µ JVMì˜ `Heap` í˜¹ì€ `Stack`ì— ìœ„ì¹˜í•  ìˆ˜ ìˆë‹¤.
- `Heap`ì€ ëª¨ë“  `thread`ì—ì„œ ê³µí†µìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë‚˜ `Stack`ì€ `thread` ë³„ë¡œ ì¡´ì¬í•œë‹¤.

```java

@RequiredArgsConstructor
public class MemberService {
	private final MemberRepository memberRepository;

	// 1) method ë‚´ì—ì„œ ë³€ìˆ˜ í• ë‹¹ ì‹œ `stack`ì— ì˜¬ë¼ê°„ë‹¤.
	// ì´ ê²½ìš° í•˜ë‚˜ì˜ `thread` í•œì •ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
	public String getMemberName(Long id) {
		Member member = memberRepository.findById(id);

		// 2) `member`ì— ëŒ€í•´ì„œëŠ” ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ ì™¸ë¶€ `thread`ë¡œë¶€í„° ì•ˆì „í•˜ë‹¤.
		// ì´ë¥¼ ê³µìœ í•˜ê¸° ìœ„í•´ì„œ return ê°’ìœ¼ë¡œ ì œê³µí•´ì•¼ í•œë‹¤.
		return member.getName();
	}
}
```

- ë”°ë¼ì„œ `ThreadLocal`ì„ ì‚¬ìš©í•˜ë©´ return ê°’ìœ¼ë¡œ ì œê³µí•˜ì§€ ì•Šê³ ë„ `thread` ë³„ë¡œ ê³ ìœ í•œ ê°’ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.

<br />

#### ğŸ”µ ë™ì‹œì„± ë¬¸ì œ

- ë™ì‹œì„± ë¬¸ì œë€ ì—¬ëŸ¬ `thread`ê°€ ë™ì‹œì— ê°™ì€ `instance field` ê°’ì„ ë³€ê²½í•˜ë©´ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œ
- íŠ¸ë˜í”½ì´ ì‚¬ì‹¤ 2ì´ˆë§ˆë‹¤ í•œ ë²ˆì”© ë°œìƒí•œë‹¤ë©´ ë™ì‹œì„± ë¬¸ì œëŠ” ì˜ ë‚˜íƒ€ë‚˜ì§€ ì•Šê³ , ì´í›„ íŠ¸ë˜í”½ì´ ëŠ˜ë©´ì„œ ë¬¸ì œê°€ ìƒê¸´ë‹¤.
- íŠ¹íˆ ìŠ¤í”„ë§ ë¹ˆì²˜ëŸ¼ ì‹±ê¸€í†¤ ê°ì²´ì˜ í•„ë“œë¥¼ ë³€ê²½í•˜ë©´ì„œ ì‚¬ìš©í•  ë•Œì—ëŠ” ë™ì‹œì„± ë¬¸ì œë¥¼ ì¡°ì‹¬í•´ì•¼ í•œë‹¤.

<br />

#### ğŸ”µ ìŠ¤í”„ë§ ë¹ˆì—ì„œì˜ ë™ì‹œì„± ë¬¸ì œ

```java

@Service
public class UserService {
	// ì‹±ê¸€í†¤ ê°ì²´ì˜ í•„ë“œ
	private Map<Long, User> userCache = new HashMap<>();

	public User getUserById(Long id) {
		User user = userCache.get(id);
		if (user == null) {
			user = userRepository.findById(id).orElse(null);
			if (user != null) {
				userCache.put(id, user);
			}
		}
		return user;
	}
}
```

- `UserService`ëŠ” ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ë©° ì‹±ê¸€í†¤ ê°ì²´ì´ë‹¤.
- ë”°ë¼ì„œ `userCache`ëŠ” ëª¨ë“  `thread`ê°€ ê³µìœ í•˜ëŠ” í•„ë“œì´ë‹¤.
- ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì—¬ëŸ¬ `thread`ì—ì„œ ë™ì‹œì— `userCache`ì— ì ‘ê·¼í•˜ê²Œ ë˜ë©° ì˜ˆê¸°ì¹˜ ì•Šì€ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

<br />

#### ğŸ”µ ìœ„ ì½”ë“œë¥¼ ê³ ì¹œë‹¤ë©´ ?

- `Map` ëŒ€ì‹  `ConcurrentHashMap` ì‚¬ìš©
- `synchronized` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ `method`ì— `lock`ì„ ê±¸ì–´ì¤€ë‹¤.
- `ThreadLocal`ì„ ì‚¬ìš©í•œë‹¤ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

```java

@Service
public class UserService {
	private ThreadLocal<Map<Long, User>> userCache = ThreadLocal.withInitial(HashMap::new);

	public User getUserById(Long id) {
		Map<Long, User> cache = userCache.get();
		User user = cache.get(id);
		if (user == null) {
			user = userRepository.findById(id).orElse(null);
			if (user != null) {
				cache.put(id, user);
			}
		}

		// ThreadLocal ë³€ìˆ˜ ì œê±°
		userCache.remove();
		return user;
	}
}
```

<br />

## 2. `Thread Local`ì˜ ì‚¬ìš©ë²•

1. `ThreadLocal` ê°ì²´ ìƒì„±
2. `ThreadLocal.set()` ë©”ì„œë“œë¥¼ í†µí•´ í˜„ì¬ `Thread` ë¡œì»¬ ë³€ìˆ˜ì— ê°’ì„ ì €ì¥
3. `ThreadLocal.get()` ë©”ì„œë“œë¥¼ í†µí•´ í˜„ì¬ `Thread` ë¡œì»¬ ë³€ìˆ˜ ê°’ ê°€ì ¸ì˜¤ê¸°
4. `ThreadLocal.remove()` ë©”ì„œë“œë¥¼ í†µí•´ í˜„ì¬ `Thread` ë¡œì»¬ ë³€ìˆ˜ ê°’ ì‚­ì œ

```java

public class ThreadLocalExample {

	public static void main(String[] args) {
		// 1) í˜„ì¬ `thread`ì™€ ê´€ë ¨ëœ ë¡œì»¬ ë³€ìˆ˜ ìƒì„±
		ThreadLocal<String> threadLocal = new ThreadLocal<>();

		// 2) `thread` ë¡œì»¬ ë³€ìˆ˜ì— ê°’ ì„¤ì •
		threadLocal.set("Hello World");

		// 3) `thread` ë¡œì»¬ ë³€ìˆ˜ ê°’ ê°€ì ¸ì˜¤ê¸°
		System.out.println(threadLocal.get());

		// 4) `thread` ë¡œì»¬ ë³€ìˆ˜ ê°’ ì‚­ì œ
		threadLocal.remove();
	}
}
```

## 3. `ThreadLocal` ì‚¬ìš©ì²˜

### 3-1. `Spring Security`ì—ì„œ ì‚¬ìš©

- `Spring Security`ì—ì„œëŠ” `ThreadLocal`ì„ ì‚¬ìš©í•˜ì—¬ `SecurityContext`ë¥¼ ì €ì¥í•œë‹¤.
- ë”°ë¼ì„œ ì‚¬ìš©ìë§ˆë‹¤ ë‹¤ë¥¸ ì¸ì¦ ì •ë³´ ì„¸ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

<br />

### 3-2. `Spring Transaction`ì—ì„œ ì‚¬ìš©

- `Spring Transaction`ì˜ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” `ThreadLocal`ì„ ì‚¬ìš©í•˜ì—¬ íŠ¸ëœì­ì…˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì „íŒŒí•œë‹¤.

<br />

### 3-3. `Thread-safe`í•´ì•¼ í•˜ëŠ” ë°ì´í„° ë³´ê´€

- `ThreadLocal`ì€ `Thread` ë³„ë¡œ ê³ ìœ í•œ ê°’ì„ ê°€ì§€ëŠ” ë³€ìˆ˜ì´ë‹¤.
- ë”°ë¼ì„œ `Thread-safe`í•´ì•¼ í•˜ëŠ” ë°ì´í„°ë¥¼ ë³´ê´€í•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

<br />

### 3-4. `ThreadLocal` ì‚¬ìš© ì£¼ì˜

1. `Thread Pool`ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê²½ìš° `ThreadLocal` ë³€ìˆ˜ ì‚¬ìš©ì´ ëë‚˜ë©´ ë°˜ë“œì‹œ `remove()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì•¼ í•œë‹¤.
    - ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì¬ì‚¬ìš© ë˜ëŠ” `thread`ê°€ ì§€ìš°ì§€ ì•Šì€ ì´ì „ ë°ì´í„°ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤.

<br />

## 4. `ThreadLocal` ì¥ì 

### 4-1. `thread` ì•ˆì „ì„± ë³´ì¥

- ê° `thread`ë³„ë¡œ ê³ ìœ í•œ ê°’ì„ ê°€ì§€ë¯€ë¡œ ì¶©ëŒì´ë‚˜ ê°„ì„­ ë°©ì§€

<br />

### 4-2. ê°„ê²°í•œ ì½”ë“œ

- `thread` ì•ˆì „ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ `synchronized` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

#### ğŸ”µ `ThreadLocal` X

```java
public class SharedObject {
	private static int count = 0;

	public static synchronized int getCount() {
		return count++;
	}
}
```

- `synchronized` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ì½”ë“œ êµ¬í˜„ë„ ë³µì¡í•´ì§€ê³  ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤€ë‹¤.

<br />

#### ğŸ”µ `ThreadLocal` O

```java
public class ThreadLocalObject {
	private static final ThreadLocal<Integer> count = ThreadLocal.withInitial(() -> 0);

	public static int getCount() {
		return count.get();
	}

	public static void setCount(int value) {
		count.set(value);
	}
}
```

- `ThreadLocal`ì„ ì‚¬ìš©í•˜ë©´ ë™ê¸°í™” ì²˜ë¦¬ ìœ„í•œ ë³„ë„ì˜ ì½”ë“œê°€ í•„ìš” ì—†ë‹¤.

<br />

### 4-3. ì„±ëŠ¥ í–¥ìƒ

- `ThreadLocal`ì„ ì‚¬ìš©í•˜ë©´ `thread` ê°„ì˜ ê³µìœ  ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì„±ëŠ¥ í–¥ìƒì´ ê°€ëŠ¥í•˜ë‹¤.
    - `thread` ê°„ì˜ ê³µìœ  ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ `thread` ê°„ì˜ ë™ê¸°í™” ì²˜ë¦¬ê°€ í•„ìš”í•˜ë‹¤. (`synchronized` í‚¤ì›Œë“œ ì‚¬ìš©)

<br />

### 4-4. ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€

- `ThreadLocal`ì„ ì‚¬ìš©í•˜ë©´ `thread`ê°€ ì¢…ë£Œë˜ë©´ `thread` ì¢…ë£Œ ì‹œ ìë™ìœ¼ë¡œ ì œê±° ëœë‹¤.
- but `ThreadPool`ì„ ì‚¬ìš©í•œë‹¤ë©´ `thread`ê°€ ì¢…ë£Œë˜ì§€ ì•Šê³  ì¬ì‚¬ìš©ë˜ë¯€ë¡œ `thread` ì¢…ë£Œ ì‹œ `remove()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì•¼ í•œë‹¤.

<br />

## 5. `ThreadLocal` ê¶ê¸ˆì¦

### 5-1. `ThreadLocal`ì€ ì™œ `static` í‚¤ì›Œë“œê°€ ì„ ì–¸ë˜ì—ˆì„ê¹Œ?

- ì•„ì§ ê¶ê¸ˆí•œ ìƒíƒœ

### ì¶œì²˜

1. [ìë°”ìº”(Java Can Do IT) :: ThreadLocal ì‚¬ìš©ë²•ê³¼ í™œìš©](https://javacan.tistory.com/entry/ThreadLocalUsage)
2. [Kimtaeng :: ìë°” ThreadLocal: ì‚¬ìš©ë²•ê³¼ ì£¼ì˜ì‚¬í•­](https://madplay.github.io/post/java-threadlocal)
3. [ì¸í”„ëŸ° ê¹€ì˜í•œ ê°•ì‚¬ë‹˜ :: ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ - ê³ ê¸‰í¸](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%ED%95%B5%EC%8B%AC-%EC%9B%90%EB%A6%AC-%EA%B3%A0%EA%B8%89%ED%8E%B8/dashboard)

